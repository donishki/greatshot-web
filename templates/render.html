{% extends "layout.html" %}
{% block title %}Render output{% endblock %}

{% macro render_streamable(shortcode) %}
<div class="wrap" {% if shortcode|length==0 %}style="display:none;"{% endif %}">
    <a href="https://streamable.com/{{ shortcode }}">streamable.com - HD version* </a>
    <div style="width: 100%; height: 0px; position: relative; padding-bottom: 56.250%;">
        <iframe src="https://streamable.com/e/{{ shortcode }}" frameborder="0" allowfullscreen webkitallowfullscreen mozallowfullscreen scrolling="no" style="width: 100%; height: 100%; position: absolute;"></iframe>
    </div>
    <p>*HD doesn't work with embeded video</p>
</div>

{% endmacro %}

{% block content %}
<h1>{{ render.title }}</h1>
{% if render.streamable_short %}
  {{ render_streamable(render.streamable_short) }}
{% else %}
<script>

function get_worker_last_beat(element){
        $.ajax({url: "/get_worker_last_beat", dataType: "json", success: function(data){
            element.append("</br>Last time worker was online:" + new Date(data));
        }
    });
}

function doPoll(firstPoll=false){

  $.ajax({url: "/renders/{{ render.id }}", dataType: "json", success: function(task){
        if (!firstPoll && task.status_msg=='started') {
          $('.progress-bar').css({'width': 100 + '%'});
          $('.progress-bar').html("No rendering worker available, reload page later");
          setTimeout(doPoll,30000);
          get_worker_last_beat($('#progress-info-more').html("Rendering is done on my PC. If there is no rendering worker available, that means I don't have it turned on, but your request is enqueued, so you don't have to send it again. It will get processed when I turn on the worker. You can PM me on discord if its OFF and you want to render something."));
        }
        else if (task.status_msg!='finished') {
          $('.progress-bar').css({'width': task.progress + '%'});
          $('.progress-bar').html(task.status_msg);
          setTimeout(doPoll,3000);
         } else {
          $('#progress-info').hide();
          $('.wrap iframe').attr('src',$('.wrap iframe').attr('src')+task+'?autoplay=1&hd=1');
          $('.wrap a').attr('href',$('.wrap a').attr('href')+task);
          $('.wrap').show();
        }
    }});
}

$(function() {
  doPoll(true);
});
</script>

{% if render.progress %}
    {% set progress = render.progress %}
{% else %}
    {% set progress = '100' %}
{% endif %}


<div id="progress-info">
    <div class="progress">
      <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:{{ render.progress }}%">
          {{ render.status_msg }}
      </div>
    </div>
    <div id="progress-info-more"></div>
</div>
{{ render_streamable("") }}
{% endif %}


{#
  <video controls>
    <source src="/static/render.mp4" type="video/mp4">
  </video>
  <a href="/static/render.mp4">Download render</a>
#}

{% endblock %}

